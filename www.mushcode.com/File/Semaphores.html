<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Code: Semaphores</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- Apple devices fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- Apple devices fullscreen -->
    <meta names="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- Bootstrap -->
	<link rel="stylesheet" href="../Theme/Flat/html/css/bootstrap.min.css">
	<!-- Bootstrap responsive -->
	<link rel="stylesheet" href="../Theme/Flat/html/css/bootstrap-responsive.min.css">
	<!-- jQuery UI -->
	<link rel="stylesheet" href="../Theme/Flat/html/css/plugins/jquery-ui/smoothness/jquery-ui.css">
	<link rel="stylesheet" href="../Theme/Flat/html/css/plugins/jquery-ui/smoothness/jquery.ui.theme.css">
	<!-- Theme CSS -->
	<link rel="stylesheet" href="../Theme/Flat/html/css/style.css">
	<!-- Color CSS -->
	<link rel="stylesheet" href="../Theme/Flat/html/css/themes.css">


    <link rel="stylesheet" href="../Content/site.css">

    <!-- jQuery -->
    <script src="../Theme/Flat/html/js/jquery.min.js"></script>
    <!-- Nice Scroll -->
    <script src="../Theme/Flat/html/js/plugins/nicescroll/jquery.nicescroll.min.js"></script>
    <!-- jQuery UI -->
    <script src="../Theme/Flat/html/js/plugins/jquery-ui/jquery.ui.core.min.js"></script>
    <script src="../Theme/Flat/html/js/plugins/jquery-ui/jquery.ui.widget.min.js"></script>
    <script src="../Theme/Flat/html/js/plugins/jquery-ui/jquery.ui.mouse.min.js"></script>
    <script src="../Theme/Flat/html/js/plugins/jquery-ui/jquery.ui.resizable.min.js"></script>
    <script src="../Theme/Flat/html/js/plugins/jquery-ui/jquery.ui.sortable.min.js"></script>
    <!-- slimScroll -->
    <script src="../Theme/Flat/html/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
    <!-- Bootstrap -->
    <script src="../Theme/Flat/html/js/bootstrap.min.js"></script>
    <!-- Form -->
    <script src="../Theme/Flat/html/js/plugins/form/jquery.form.min.js"></script>

    <!-- Theme framework -->
    <script src="../Theme/Flat/html/js/eakroko.min.js"></script>
    <!-- Theme scripts -->
    <script src="../Theme/Flat/html/js/application.min.js"></script>

    <!--[if lte IE 9]>
		<script src="js/plugins/placeholder/jquery.placeholder.min.js"></script>
		<script>
			$(document).ready(function() {
				$('input, textarea').placeholder();
			});
		</script>
	<![endif]-->

    <!-- Favicon -->
    <link rel="shortcut icon" href="http://www.mushcode.com/File/img/favicon.ico" />
    <!-- Apple devices Homescreen icon -->
    <link rel="apple-touch-icon-precomposed" href="http://www.mushcode.com/File/img/apple-touch-icon-precomposed.png" />

</head>

<body class="theme-green">
    <div id="navigation">
        <div class="container-fluid">
            <a href="../index.html" id="brand">MUSHCode.com</a>
        </div>
    </div>
    <div class="container-fluid" id="content">
        <div id="left">
            <div class="subnav">
                <div class="subnav-title">
                    <a href="Semaphores.html#" class='toggle-subnav'>
                        <i class="icon-angle-down"></i>
                        <span>About</span>
                    </a>
                </div>
                <ul class="subnav-menu">
                    <li>
                        <a href="../index.html">Overview</a>
                    </li>
                </ul>
            </div>
            <div class="subnav">
                <div class="subnav-title">
                    <a href="Semaphores.html#" class='toggle-subnav'>
                        <i class="icon-angle-down"></i>
                        <span>Files</span>
                    </a>
                </div>
                <ul class="subnav-menu">
                    <li class='dropdown'>
                        <a href="Semaphores.html#" data-toggle="dropdown">Code</a>
                        
<ul class="dropdown-menu">
        <li>
            <a href="../Category/Administration.html">Administration</a>
        </li>
        <li>
            <a href="../Category/Building.html">Building</a>
        </li>
        <li>
            <a href="../Category/Bulletin-Board.html">Bulletin Board</a>
        </li>
        <li>
            <a href="../Category/Combat.html">Combat</a>
        </li>
        <li>
            <a href="../Category/Dynamic-Space.html">Dynamic Space</a>
        </li>
        <li>
            <a href="../Category/Fonts.html">Fonts</a>
        </li>
        <li>
            <a href="../Category/Functions.html">Functions</a>
        </li>
        <li>
            <a href="../Category/Games.html">Games</a>
        </li>
        <li>
            <a href="../Category/Globals.html">Globals</a>
        </li>
        <li>
            <a href="../Category/Mail-Systems.html">Mail Systems</a>
        </li>
        <li>
            <a href="../Category/Other.html">Other</a>
        </li>
        <li>
            <a href="../Category/Schedulers.html">Schedulers</a>
        </li>
        <li>
            <a href="../Category/Time.html">Time</a>
        </li>
        <li>
            <a href="../Category/Vehicles.html">Vehicles</a>
        </li>
        <li>
            <a href="../Category/Vendors.html">Vendors</a>
        </li>
        <li>
            <a href="../Category/Weather-Systems.html">Weather Systems</a>
        </li>
</ul>
                    </li>
                    <li class='dropdown'>
                        <a href="Semaphores.html#" data-toggle="dropdown">Classes</a>
                        
<ul class="dropdown-menu">
        <li>
            <a href="../Category/Administration.html">Administration</a>
        </li>
        <li>
            <a href="../Category/Building.html">Building</a>
        </li>
        <li>
            <a href="../Category/Globals.html">Globals</a>
        </li>
        <li>
            <a href="../Category/Hardcode.html">Hardcode</a>
        </li>
        <li>
            <a href="../Category/Other.html">Other</a>
        </li>
        <li>
            <a href="../Category/Softcode.html">Softcode</a>
        </li>
</ul>
                    </li>
                    <li>
                        <a href="../Manuals.html">Manuals</a>
                    </li>
                </ul>
            </div>
            <div class="subnav">
                <div class="subnav-title">
                    <a href="Semaphores.html#" class='toggle-subnav'>
                        <i class="icon-angle-down"></i>
                        <span>Misc</span>
                    </a>
                </div>
                <ul class="subnav-menu">
                    <li>
                        <a href="../Ascii2Mu.html">ASCII To MUSHCode</a>
                    </li>
                    <li>
                        <a href="../MushList.html">MUSH/MUX List</a>
                    </li>
                    <li>
                        <a href="../MushRoom.html">MUSHRoom</a>
                    </li>
                </ul>
            </div>
            <div class="subnav">
                <div class="subnav-title">
                    <a href="Semaphores.html#" class='toggle-subnav'>
                        <i class="icon-angle-down"></i>
                        <span>Contribute</span>
                    </a>
                </div>
                <ul class="subnav-menu">
                    <li>
                        <a href="../Submit.html">Submit</a>
                    </li>
                </ul>
            </div>
        </div>
        <div id="main">
            <div class="container-fluid">
                <div class="breadcrumbs">
                    <ul>
                        
    <li>
        <a href="../index.html">Home</a>
        <i class="icon-angle-right"></i>
    </li>
    <li>
        <a href="../Category/Softcode.html">Softcode</a>
        <i class="icon-angle-right"></i>
    </li>
    <li>
        <a href="Semaphores.html#">Semaphores</a>
    </li>

                    </ul>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                        



<div class="box">
    <div class="box-title title">
        <h2>
            Semaphores
        </h2>
    </div>
    <div class="box-content">

        <div class="description">
            <p>MUSH 101&#39;s first guest lecture. Javelin walks through SEMAPHORE.</p>
        </div>

        <div class="author">
            <strong>Author:</strong>
                <span>
                    <a href="../Author/Javelin@M-U-S-H.html">Javelin</a>@<a href="../Source/M-U-S-H.html">M*U*S*H</a>
                </span>
        </div>

        <div class="author">
            <strong>Category:</strong>
            <a href="../Category/Softcode.html">Softcode</a>
        </div>

            <div class="commands">
            <strong>Commands:</strong>
                    <a href="http://www.mushcode.com/Command/@dolist" class="command">@dolist</a>,
                    <a href="http://www.mushcode.com/Command/@drain" class="command">@drain</a>,
                    <a href="http://www.mushcode.com/Command/@emit" class="command">@emit</a>,
                    <a href="../Command/@notify.html" class="command">@notify</a>,
                    <a href="http://www.mushcode.com/Command/@va" class="command">@va</a>,
                    <a href="http://www.mushcode.com/Command/@vb" class="command">@vb</a>,
                    <a href="http://www.mushcode.com/Command/@wait" class="command">@wait</a>.
            </div>

            <div class="functions">
                <strong>Functions:</strong>
                        <a href="../Function/get.html" class="function">get&#40;&#41;</a>,
                        <a href="../Function/hasattr.html" class="function">hasattr&#40;&#41;</a>,
                        <a href="../Function/lcon.html" class="function">lcon&#40;&#41;</a>,
                        <a href="../Function/name.html" class="function">name&#40;&#41;</a>,
                        <a href="../Function/room.html" class="function">room&#40;&#41;</a>,
                        <a href="../Function/step.html" class="function">step&#40;&#41;</a>,
                        <a href="../Function/switch.html" class="function">switch&#40;&#41;</a>,
                        <a href="../Function/v.html" class="function">v&#40;&#41;</a>.
            </div>


            <div class="servers">
                <strong>Compatibility:</strong>
                        <a href="../Server/PennMUSH.html" class="server">PennMUSH</a>,
                        <a href="../Server/TinyBit.html" class="server">TinyBit</a>,
                        <a href="../Server/TinyMUSH.html" class="server">TinyMUSH</a>,
                        <a href="../Server/TinyMUX.html" class="server">TinyMUX</a>.
            </div>

    </div>
</div>


<div class="box box-bordered box-condensed">
    <div class="box-title">
        <h3>
	        <i class="icon-reorder"></i>
	        MUSHCode for Semaphores
        </h3>
        <div class="actions">
	        <a class="btn btn-mini select-all" href="Semaphores.html#">
                    <i class="icon-resize-full"></i> Select Content
            </a>
        </div>
    </div>
    <div id="code" class="box-content content">
        Topic: Semaphores<br/>Author: Javelin<br/>Summary: MUSH 101's first guest lecture. Javelin walks through SEMAPHORE.<br/><br/>Log file from MUSH101<br/><br/>Classroom 1102<br/><br/>	A chalkboard fills one wall, with an old beat-up lectern in front of<br/>it. The other three walls are painted off-white. Several chairs with attached<br/>desktop-like surfaces (standard classroom chairs) are scattered about in no<br/>particular order.<br/><br/><br/>Contents:<br/>Rhysem<br/>Grinna<br/>Yosh<br/>Hephtur<br/>Vedui<br/>Lianne<br/>Halatir<br/>Javelin<br/>Gothuga<br/>Obvious exits:<br/>Out &lt;O&gt;<br/><br/>Trispis walks to the front of the classroom and begins speaking in a dry<br/>monotone, "Welcome to MUSH 101's third code class. We'll be starting<br/>momentarily. If you haven't read the 'rules', please do so now (type: rules). <br/>Our featured speaker is Javelin of M*U*S*H, current maintainer of PennMUSH. <br/>His topic for today is semaphores. Please enjoy the class."<br/><br/>	Online classrooms are difficult to present. Since the entire class<br/>will be text-based, any excessive chatter can quickly become annoying. So,<br/>please observe the following courtesies for both your instructor and your<br/>fellow student.<br/><br/>1. The instructor is in charge of the classroom for the duration of his/her<br/>presentation. This authority extends to the +code channel as well. The only<br/>people above him in authority are admins and wizards, but their job is simply<br/>to enforce the instructor's authority.<br/><br/>2. If you have a question, pose a question mark (?) on the +code channel (to<br/>join this channel, type: @chan/on code). You will be allowed to ask your<br/>question when called upon (it's a good idea to have paper and pencil for<br/>writing down questions, as it may be several minutes before you are allowed to<br/>ask).<br/><br/>3. We want the class to be fun and interesting, but excessive horseplay<br/>(wise-cracking and the like) is disruptive to those who are here to learn. <br/>Please direct horseplay and joking to the +pub&amp;grille channel (so people can<br/>turn it off, if they wish).<br/><br/>Trispis dances a little jig, after his speech, and turns the lecturn over to<br/>Javelin, "Take it away, Meistro." (:<br/><br/>Javelin chuckles.<br/>Javelin says, "Ok, let's start with a problem."<br/>Javelin drops Race Condition.<br/>Javelin points to "Race Condition". Examine that object, if you please. :)<br/><br/>Race Condition(#1904V)<br/>Type: Thing Flags: VISUAL<br/>Owner: Javelin	Zone: *NOTHING*  Credits: 1<br/>Parent: *NOTHING*<br/>Powers: <br/>Warnings checked: none<br/>Created: Sat Feb 14 20:08:19 1998<br/>Last Modification: Sat Feb 14 20:10:13 1998<br/>VA [#1649]: Javelin<br/>FLIP2 [#1649]: @emit The winner is %va!<br/>FLIP [#1649]: $flip: @va me=%N; @tr me/flip2<br/>Home: Javelin's Room(#XXXXRn)<br/>Location: Classroom 1102(#236R)<br/><br/>Javelin says, "Here's a simple object. You type 'flip', and it tells you that<br/>you win."<br/>Javelin types flip<br/>The winner is Javelin!<br/>The winner is Yosh!<br/>The winner is Trispis!<br/>The winner is Halatir!	       &lt;--+-- Note these two lines.<br/>The winner is Halatir!	       &lt;--'<br/>The winner is Gothuga!<br/><br/>Javelin giggles. "Now, perhaps we just saw the problem with this object."<br/>Javelin says, "If A has just typed 'flip', and B types 'flip' right after, VA<br/>may get set to B's name *before* FLIP2 is run for A."<br/>Javelin says, "As a result, we'll see "The winner is B!" twice, instead of<br/>"The winner is A!" followed by "The winner is B!""<br/>Javelin says, "Does everybody understand the problem?"<br/><br/>Yosh nods<br/>Gothuga nods<br/>Trispis nods.<br/>Lianne nods<br/>Halatir nods.<br/>Rhysem nods<br/>Grinna nods<br/>Vedui *8)s.<br/><br/>Javelin says, "Ok. This problem is called a 'race condition' -- because if<br/>people are racing to run the command, it can get mixed. Semaphores are a<br/>coding concept that offer us a fix for this. Let's look at a partial fix<br/>first."<br/>Javelin drops Partial Fix.<br/>Javelin suggests: ex partial fix<br/><br/>Partial Fix(#1909Vn)<br/>Type: Thing Flags: VISUAL NO_COMMAND<br/>Owner: Javelin	Zone: *NOTHING*  Credits: 1<br/>Parent: *NOTHING*<br/>Powers: <br/>Warnings checked: none<br/>Created: Sat Feb 14 22:07:59 1998<br/>Last Modification: Sat Feb 14 22:08:26 1998<br/>FLIP2 [#1649]: @emit The winner is %va!<br/>FLIP [#1649]: $spin: @wait me={@va me=%N; @tr me/flip2}<br/>Home: Javelin's Room(#XXXXRn)<br/>Location: Classroom 1102(#236R)<br/>Sat Feb 14 22:09:34 1998<br/><br/>Javelin says, "What's new here? We've added '@wait me=' in front of the list<br/>of commands run by the FLIP attribute."<br/>Javelin says, "Instead of immediately executing those two commands, the object<br/>will 'wait' for a signal to do so."<br/>Javelin says, "Examine partial fix again."<br/><br/>Partial Fix(#1909V)<br/>Type: Thing Flags: VISUAL<br/>Owner: Javelin	Zone: *NOTHING*  Credits: 1<br/>Parent: *NOTHING*<br/>Powers: <br/>Warnings checked: none<br/>Created: Sat Feb 14 22:07:59 1998<br/>Last Modification: Sat Feb 14 22:10:49 1998<br/>SEMAPHORE [#1+i]: 2<br/>FLIP2 [#1649]: @emit The winner is %va!<br/>FLIP [#1649]: $spin: @wait me={@va me=%N; @tr me/flip2}<br/>Home: Javelin's Room(#XXXXRn)<br/>Location: Classroom 1102(#236R)<br/><br/>Javelin says, "You'll see that there's a new atttribute, called SEMAPHORE,<br/>which shows how many of those signals the object is waiting on."<br/>Javelin says, "We can see that two people have already typed 'spin'."<br/>Javelin says, "When an object is waiting on a semaphore like this, the @notify<br/>command is used to send a single signal (say that 3 times fast!)."<br/>Javelin says, "I'll type: @notify partial fix"<br/>The winner is Trispis!<br/><br/>Trispis woohoos! (:<br/><br/>&lt;Pub&amp;Grille&gt; q:*D Halatir hrms. ;)<br/><br/>&lt;Pub&amp;Grille&gt; Trispis says, "Not bad for a wizard who's half asleep. (:"<br/><br/>Javelin says, "When the object is @notified, the SEMAPHORE attribute is<br/>reduced by 1, and the commands that the object was waiting to execute are<br/>executed."<br/><br/>Javelin does a couple more notifies.<br/>The winner is Yosh!<br/>The winner is Gothuga!<br/><br/>&lt;Code&gt; Trispis says, "?"<br/>&lt;Code&gt; Trispis notes his own question.<br/><br/>Javelin says, "There are only 3 things you can do involving semaphores: @wait<br/>on a semaphore, @notify a sempahore, and, finally @drain a semaphore. @drain<br/>removes the commands that are waiting without executing them."<br/>Javelin drains fix.<br/>Javelin says, "If you ex fix now, the SEMAPHORE attribute is gone."<br/><br/>Partial Fix(#1909V)<br/>Type: Thing Flags: VISUAL<br/>Owner: Javelin	Zone: *NOTHING*  Credits: 1<br/>Parent: *NOTHING*<br/>Powers: <br/>Warnings checked: none<br/>Created: Sat Feb 14 22:07:59 1998<br/>Last Modification: Sat Feb 14 22:14:24 1998<br/>VA [#1649]: Gothuga<br/>FLIP2 [#1649]: @emit The winner is %va!<br/>FLIP [#1649]: $spin: @wait me={@va me=%N; @tr me/flip2}<br/>Home: Javelin's Room(#XXXXRn)<br/>Location: Classroom 1102(#236R)<br/><br/>Javelin says, "Ok, everybody set a semaphore on themselves, using this<br/>command: @wait me=think notified!"<br/><br/>Javelin says, "When you've done that, type @ps"<br/><br/>Queue for : Trispis<br/>Player Queue:<br/>Object Queue:<br/>Wait Queue:<br/>Semaphore Queue:<br/>[#4]Trispis(#4POUWnACMc):think notified!<br/>------------  Queue Done  ------------<br/>Totals: Player...0/0[0del]  Object...0/0[0del]	Wait...0/3  Semaphore...1/8<br/><br/>Javelin says, "Notice how your Semaphore Queue now shows the command that you<br/>have waiting on yourself."<br/>Javelin says, "When you've seen that, @notify or @drain yourself."<br/>Notified.<br/>notified!<br/><br/>&lt;Pub&amp;Grille&gt; q:*D Mewis says, "notified!"<br/><br/>Javelin says, "Are there any questions so far?"<br/><br/>Trispis nods. Only one, so far. You ready?<br/><br/>Javelin says, "Yep."<br/><br/>Trispis says, "Are all activations of the $command placed into ordered @waits<br/>(in the holding queue, or whatever)? Like 'Trispis, Gothuga, Halatir, etc'...<br/>were they all being held in stasis somewhere?"<br/><br/>Javelin says, "Correct. TO see this, try something like this: <br/>@dol 1 2 3=@wait me=think ##"<br/>Javelin says, "Then type @ps"<br/><br/>Queue for : Trispis<br/>Player Queue:<br/>Object Queue:<br/>Wait Queue:<br/>Semaphore Queue:<br/>[#4]Trispis(#4POUWnACMc):think 1<br/>[#4]Trispis(#4POUWnACMc):think 2<br/>[#4]Trispis(#4POUWnACMc):think 3<br/>------------  Queue Done  ------------<br/>Totals: Player...0/0[0del]  Object...0/0[0del]	Wait...0/3  Semaphore...3/16<br/><br/>Notified.<br/>1<br/>Notified.<br/>2<br/>Notified.<br/>3<br/><br/>Sat Feb 14 22:19:37 1998<br/><br/>Javelin says, "You should see 3 commands on your semaphore queue. If you use<br/>@notify/all me, they'll all be run, in order"<br/><br/>Trispis says, "Ah. Okay. Cool. (:"<br/><br/>&lt;Code&gt; Trispis says, "?"<br/><br/>&lt;Code&gt; Javelin says, "Yeah, Tris?"<br/><br/>&lt;Code&gt; Trispis has a followup to his earlier question (and your example)... Is<br/>there a way to limit the number of semaphores permitted (like no more than 2,<br/>then that @dol 1 2 3 would get curtailed after 2)?<br/><br/>&lt;Code&gt; Javelin says, "Nope, afraid not."<br/><br/>Javelin says, "Ok, now there's one very neat thing about semaphores I haven't<br/>mentioned."<br/>Javelin says, "Everybody @drain yourself, and then type @notify me"<br/><br/>Drained.<br/><br/>Notified.<br/><br/>Javelin says, "Then ex me/SEMAPHORE"<br/><br/>SEMAPHORE [#1+i]: -1<br/><br/>Javelin says, "You'll see that you have a *negative* semaphore count, because<br/>you've notified yourself when you didn't have any command waiting."<br/><br/>Javelin says, "What's so great about a negative semaphore? Well, a -1<br/>semaphore means that the next time you @wait on yourself, you'll execute the<br/>command *immediately*, and your semaphore count will go back to 0. This is the<br/>basis of the solution to our race condition."<br/>Javelin drops Semaphore Solution.<br/>Javelin suggests: ex solution<br/><br/>Semaphore Solution(#1905Vz)<br/>Type: Thing Flags: VISUAL STARTUP<br/>Owner: Javelin	Zone: *NOTHING*  Credits: 1<br/>Parent: *NOTHING*<br/>Powers: <br/>Warnings checked: none<br/>Created: Sat Feb 14 20:08:28 1998<br/>Last Modification: Sat Feb 14 22:17:36 1998<br/>STARTUP [#1649$]: @drain me; @notify me<br/>SEMAPHORE [#1+i]: -1<br/>FLIP2 [#1649]: @emit The winner is %va!; @notify me<br/>FLIP [#1649]: $toss: @wait me={@va me=%N; @tr me/flip2}<br/>Home: Javelin's Room(#XXXXRn)<br/>Location: Classroom 1102(#236R)<br/><br/>The winner is Trispis!<br/>The winner is Gothuga!<br/>The winner is Yosh!<br/>The winner is Mewis!<br/><br/>Javelin says, "When someone types 'toss', what happens? The @va me and @tr run<br/>immediately, because there's a negative semaphore. If someone else tries to<br/>type toss right afterward, *their* command gets put on the semaphore queue,<br/>and isn't run until, at the end of the first command, the @notify me is run."<br/>Javelin says, "This is the basic way to use sempahores to enforce a single<br/>user finishing their command before anybody else's gets in the way -- <br/>(1) @notify the object so it's get a -1 semaphore, <br/>(2) put the commands on the semaphore queue with an @wait, and <br/>(3) At the end of the set of commands to be run, call @notify to bring the <br/>semaphore count back down."<br/>Javelin says, "A fancy term for this is 'mutual exclusion' or 'mutex'. I think<br/>the help file may use this term somewhere."<br/>Javelin says, "The reason the @startup is there, btw, is in case the MUSH is<br/>shut down in the middle of some command on the semaphore. When it starts back<br/>up, we want to be sure the SEMAPHORE count on that object is exactly -1, so we<br/>@drain it, and then @notify it once."<br/><br/>&lt;Code&gt; Trispis suddenly has ideas for his elevator. (:<br/><br/>&lt;Code&gt; Javelin nodnods. :) A hard thing, though, is getting the elevator to be<br/>willing to stop on, say, floor 2, when it's on the way from 3 to 1, but not be<br/>willing to stop at floor 4. Proof left to the reader.<br/><br/>&lt;Code&gt; Trispis nods.<br/><br/>Javelin says, "Let me stop here for a sec and see if there are any questions<br/>about how the solution object works, or anything else I've said so far?"<br/><br/>&lt;Code&gt; Trispis offers a simple example to see if he understands... check my<br/>thinking, please Jav...<br/><br/>&lt;Code&gt; Javelin nods.<br/><br/>&lt;Code&gt; Trispis says, "I've got a vending machine of some sort (let's call it a<br/>coffee pot)..."<br/>&lt;Code&gt; Trispis says, "I wanna have it do a series of emits (%N picks up the<br/>hot glass coffee pot. *wait* %N pours the hot black liquid into a styrofoam<br/>cup.  *wait* %N places the pot back on the warmer.)."<br/>&lt;Code&gt; Trispis says, "I'd put the @wait at the beginning of the $command... <br/>trigger the various @emits with normal @waits (with seconds or watever)... <br/>then, after the last one, I'd do a @notify &lt;pot&gt;."<br/>&lt;Code&gt; Trispis says, "That way only one person can pour a cup of java at a<br/>time?"<br/><br/>&lt;Code&gt; Javelin says, "That would work fine, yes."<br/><br/>Philip ?<br/><br/>Javelin says, "Go ahead, Philip."<br/><br/>Philip thinks he's answered his own question, but, how would you set it up so<br/>that there was only one winner? take the @notify out from the end?<br/><br/>Javelin says, "That's a little trickier, since you can only drain *all* of the<br/>semaphores off, not just some of them. You'd have to do something like decided<br/>randomly if this person was going to displace the current winner, and if so,<br/>@drain the object and set up the @wait for the new winner."<br/>Javelin says, "That's a sort of different problem. :)"<br/><br/>Philip says, "Sorry, came into the middle. =)"<br/><br/>[Trispis inserts an observation about Philip's question. My interpretation of<br/>Philip's 'problem' (i.e., only having one winner &lt;period&gt;) would occur in a<br/>situation where there is actually a race (as in a MUSH scavenger hunt, for<br/>example). Having a -1 SEMAPHORE... and then NOT @notifying the object would<br/>result in an 'only one winner' situation (all others would be accumulated as<br/>'to be queued' SEMAPHORES, which could all be @drained ). Also, if this is the<br/>desired result (only one winner), then it's probably a good idea to @halt the<br/>object after it has completed its processing of the "one winner", rather than<br/>accumulate SEMAPHORES (unless you're wanting to record 'second place', 'third<br/>place', etc).]<br/><br/>Javelin says, "Historically, semaphores came about because there was often<br/>code that should only be used by one player at a time. Some post office<br/>systems were notably like this."<br/>Javelin says, "Does anyone happen to know how they used to force code to only<br/>be useable by one player at a time in the days before semaphores?"<br/>Javelin is about to show his age. :)<br/><br/>Trispis speculates a @set %@=no_command, then reset it afterwards.<br/><br/>Javelin says, "Anybody? Anybody? Bueller? (Nope, Tris, this was before the<br/>NO_COMMAND flag, too.)"<br/>Javelin says, "Although that's a pretty clever thought. :)"<br/><br/>Vedui recalls the @force stuff I think..unless it wasn't used on belgariad.<br/><br/>Trispis imagines it's pretty hairy, then.<br/><br/>Javelin tells ya. "They used to code objects so they only worked if a player<br/>was holding them."<br/><br/>&lt;Pub&amp;Grille&gt; Trispis says, "Hot potato. (:"<br/><br/>Javelin says, "Since only one player can hold an object at once, that enforced<br/>mutual exclusion."<br/><br/>Philip says, "You could probably do it by setting an attribute in the<br/>beginning indicating that the thing was in use, and then resetting it at the<br/>end... doesn't remember the commands that were used though."<br/><br/>Vedui was thinking of something else then :P<br/><br/>Trispis says, "that's simpler than what was going through my mind. (:"<br/><br/>Gothuga hrmmms, "Couldn't anyone just take the objects and not put them back<br/>down then Jav?<br/><br/>Javelin points to his nose and indicates Gothuga approvingly. "And *that* is<br/>the $64k question"<br/><br/>Gothuga cheers..<br/><br/>Javelin says, "Consider this object"<br/>Javelin drops Two-step.<br/><br/>Two-step(#685z)<br/>Type: Thing Flags: STARTUP<br/>Owner: Javelin	Zone: *NOTHING*  Credits: 1<br/>Parent: *NOTHING*<br/>Powers: <br/>Warnings checked: none<br/>Created: Sat Feb 14 22:30:42 1998<br/>Last Modification: Sat Feb 14 22:35:17 1998<br/>STARTUP [#1649$]: @drain me; @notify me<br/>SEMAPHORE [#1+i]: -2<br/><br/>STEP2 [#1649]: $step2: @switch %#=[v(DOER)], {"%N did step two. We're done.;<br/>&amp;DOER me; @notify me}, {"Sorry, %N --<br/>[switch(hasattr(me,DOER),1,[name(v(DOER))] is using me.,do step 1 first)]}<br/>STEP1 [#1649]: $step1: @wait me={"%N did step one.; &amp;DOER me=%#}<br/>Home: Javelin's Room(#XXXXRn)<br/>Location: Classroom 1102(#236R)<br/><br/>Javelin suggests: examine two-step<br/><br/>Two-step says, "Sorry, Yosh -- do step 1 first"<br/>Two-step says, "Yosh did step one."<br/>Two-step says, "Yosh did step two. We're done."<br/><br/>Javelin says, "The idea of 'two-step' is that you want someone to type two<br/>commands, step1 and step2. Until that person types 'step2', you don't want<br/>anybody else to use the object."<br/><br/>Two-step says, "Lianne did step one."<br/>Two-step says, "Sorry, Halatir -- Lianne is using me."<br/>Two-step says, "Lianne did step two. We're done."<br/>Two-step says, "Halatir did step one."<br/>Two-step says, "Halatir did step two. We're done."<br/><br/>Trispis grins. Cool. (:<br/><br/>Javelin says, "But there's a problem."<br/>Javelin says, "And it's Gothuga's problem."<br/>Javelin says, "What if someone does step1, and then disconnects?"<br/>Javelin says, "The object becomes deadlocked -- nobody can use it right."<br/><br/>Philip suggests using Ahear?<br/><br/>Javelin says, "That's one solution, Philip -- listen for someone leaving,<br/>disconnecting, etc. But someone could still be in the room and just forget to<br/>do step2."<br/><br/>Two-step says, "Trispis did step one."<br/><br/>Trispis grins evilly and refuses to do step2. (:&lt;<br/><br/>Two-step says, "Sorry, Lianne -- Trispis is using me."<br/><br/>Javelin says, "This is why we have 'timed semaphores'"<br/>Javelin says, "A 'timed semaphore' is just like a normal semaphore, but if<br/>it's not drained or notified within a certain time, it gets automatically<br/>notified."<br/><br/>&lt;Pub&amp;Grille&gt; Trispis says, "No drinking coffee straight from the pot!!!"<br/><br/>Javelin says, "The command is: @wait me/10=think I'm notified."<br/>Javelin says, "Where 10 is the number of seconds. If you run that command, and<br/>don't @notify me within 10 seconds, you'll get notified anyway."<br/><br/>I'm notified.<br/><br/>Javelin says, "Let me give you an example of how I once used timed semaphores<br/>to solve a fairly ugly problem like this."<br/>Javelin says, "I wanted to design a soft-coded combat system that worked like<br/>this:"<br/>Javelin says, "Attacker would select a type of attack (kick, punch, or slap)"<br/>Javelin says, "Defender would select a type of defense (dodge, block, or<br/>parry)"<br/>Javelin says, "And the combat system would look up the result in a big matrix.<br/> For example, a parry was ineffective against a kick, etc."<br/>Javelin says, "There were 2 immediate problems: (1) how to remember what the<br/>attacker's attack type was and who they attacked until the defender responded,<br/>and (2) what to do if the defender lagged a lot or lost their connection."<br/>Javelin says, "Both were solved by having the combat system set a timed<br/>semaphore *on the defender*. The defense commands (dodge, block, parry),<br/>basically @notified the defender's semaphore which caused the result of the<br/>fight to be computed. But if the defender didn't respond within 5 seconds, the<br/>semaphore automatically notified (and the defender, by default, 'dodged')."<br/>Javelin notes that this is not a perfect solution, as the defender can defend<br/>attacks amazingly well by simply @draining him/herself. :) Ah well. :)<br/><br/>Trispis says, "or by doing nothing?"<br/><br/>Javelin says, "No, doing nothing causes the semaphore to time out, and thus be<br/>notified. If you did nothing, you 'dodged'."<br/>Javelin says, "A timed semaphore that times out is *notified*, not *drained*. <br/>That's important."<br/><br/>Vedui snaps his fingers! why didntcha say so when we used the combat system...<br/> @drain woulda killed all my enemies ;)<br/><br/>Gothuga chuckles..<br/><br/>Javelin points to Vedui, a long-suffering guinea pig of that particular combat<br/>system, as a matter of fact.<br/>Javelin says, "Ok, I'm just about done. There's only one more thing I want to<br/>mention, and then we can move to questions/discussion if any."<br/><br/>Trispis doesn't see how it would have killed them. maybe I'm missing<br/>something.<br/><br/>Javelin says, "It wouldn't have killed them, Tris. If you @drained yourself,<br/>it would have erased the fact that you were attacked, is all."<br/><br/>Trispis says, "Ah. Okay... allowing you to attack back?"<br/><br/>Javelin nods to Tris.<br/><br/>Gothuga says, "Letting you attack without being attacked, right?"<br/><br/>Trispis grins. Devious. (:<br/><br/>Gothuga says, "Isn't that CS still up on the PennMUSH FTP Site?"<br/><br/>Javelin nods, it's called NCS 1.0 or something, Gothuga.<br/><br/>Javelin says, "The final little tidbit is this."<br/>Javelin says, "Remember that if you're using a -1 semaphore, you want to<br/>@notify at the end of a command sequence."<br/>Javelin says, "If the command sequence includes an @switch, you must put an<br/>@notify into every branch of the switch."<br/>Javelin says, "But if the command sequence ends in an @dolist, you've got a<br/>problem."<br/>Javelin says, "You can't do: @dol a b c = whatever; @notify me"<br/>Javelin says, "Because the @notify will run *before* the 'whatever' is<br/>finished running."<br/><br/>Trispis hrms....<br/><br/>Javelin says, "(because @dol adds the 3 whatevers back onto the queue, after<br/>the @notify)"<br/>Sat Feb 14 22:59:49 1998<br/>Javelin says, "This is why, as you can see in 'help @dolist', there's a<br/>/notify switch to @dolist."<br/><br/>@DOLIST<br/>  @dolist[/notify] &lt;list&gt; = &lt;action&gt;<br/>  <br/>  @dolist executes the &lt;action&gt; for each element in &lt;list&gt;. If &lt;list&gt; is a<br/>  function, it will be evaluated to obtain the necessary list to use. It<br/>  may be any space-separated list of strings, which can be object numbers,<br/>  attributes, or arbitary words.<br/>  <br/>  &lt;action&gt; is a command or list of commands enclosed in braces { }<br/>  and is performed once for every item in &lt;list&gt;. The special symbol "##"<br/>  is replaced by the corresponding item from &lt;list&gt;.  The special symbol<br/>  "#@" is replaced by the position of that item in the list.<br/> <br/>  If the /notify switch is used, a "@notify me" is queued after all the<br/>  list commands. This is useful for object synchronization with semaphores.<br/>   <br/>  Example: @dolist [lcon(here)] = "[name(##)]<br/>    would cause you to say the name of all objects in the room.<br/><br/>Javelin says, "@dolist/notify a b c=whatever will do the whatever for a, b,<br/>and c, and *then* do an @notify."<br/>Javelin says, "It will only @notify the object that's running the @dolist, but<br/>usually, that's the right object."<br/>Javelin hopes he said that fairly clearly. To take the corresponding case with<br/>@switch, this is bad: <br/><br/>@sw a=f1, {whatever1}, {whatever2}; @notify me<br/><br/>Javelin says, "This is good: <br/><br/>@sw a=f1, {whatever1; @notify me}, {whatever2; @notify me}<br/>"<br/><br/>Javelin knows there's a lot of misunderstanding about the queue, so if you<br/>have questions, now's a good time. :)<br/><br/>Trispis ?<br/>Trispis asks his question...<br/><br/>Javelin nods.<br/><br/>Trispis says, "I know that there are times when semi-colon separated @commands<br/>are placed sequentially in the queue... and other times when they're not (as<br/>in the case of the @dol 1 2 3 ; @notify me)... Is there a rule of thumb for<br/>determining how things turn out?"<br/><br/>Javelin says, "Yes. Understand this and you become a guru. :)"<br/>Javelin says, "When an object runs commands on one of its attributes (due to<br/>being triggered by a $command, let's say...)"<br/>Javelin says, "All of the commands in that attribute are put onto the queue,<br/>one immediately after the other, in the order they appear."<br/>Javelin says, "That is, if the commands are: @va me=hi; @vb me=[get(me/va)],<br/>you can be sure that VB will contain 'hi' one this is run. Nothing can come<br/>between them, and nothing can put them out of order."<br/><br/>Trispis nods.<br/><br/>Javelin says, "Some commands explicitly place other command-list onto the<br/>queue, at the end of whatever's currently there. These include @force,<br/>@trigger, @switch, and @dolist (and @wait 0=command-list)"<br/><br/>Javelin says, "So, if the trigger command-list is: <br/><br/>@va me=hi; @dol a b c=@vb me=##; @vb me=[get(me/va)]; @emit %vb<br/><br/>... the queue starts out holding all those commands, in order. The @va is run,<br/>and VA is set to hi. Then the @dol is run, and three @VB commands are added to<br/>the back of the queue. The queue now looks like this:<br/><br/>@vb me=[get(me/va)]; @emit %vb; @vb me=a; @vb me=b; @vb me=c<br/><br/>...We keep going, VB gets set to "hi", "hi" gets emitted, and then VB gets set<br/>to "a", to "b", and to "c", and we're done."<br/><br/>Javelin says, "Similarly, consider <br/><br/>@emit hi; @sw k=f1, {a1}, {b1}; @emit bye<br/><br/>The queue starts like that, we emit hi, we decide whether a1 or b1 should be<br/>added to the back of the queue. The queue now looks like this:<br/><br/>@emit bye; a1 (or b1)<br/><br/>...We emit bye, and then we run a1 or b1. If we wanted the emit of bye to be<br/>at the end of everything, we must either do this: <br/><br/>@sw k=f1, {a1; @emit bye}, {b1; @emit bye}<br/><br/>...Or force the @emit to be cued late: <br/><br/>@sw k=f1, {a1}, {b1}; @wait 0=@emit bye<br/><br/>...Or use a semaphore; <br/><br/>@sw k=f1, {a1; @notify me}, {b1; @notify me}; @wait me=@emit byte<br/><br/>...etc."<br/><br/>Javelin says, "This is why a lot of people have given up on this and try to<br/>use side-effection functions and avoid @switch entirely (about which I have<br/>mixed feelings. :)"<br/>Javelin whews. Hope that helps. Any other questions?<br/><br/>Trispis looks around.<br/><br/>Vedui says, "?"<br/><br/>Javelin nods to Ved.<br/><br/>Vedui :) When ya @dol and @sel and all, and it considers the placement on "da<br/>queue", does it do that in consideration with other commands running as well,<br/>by other objects?<br/><br/>Trispis smiles.<br/><br/>Vedui says, "Ie... in your example above, if ya had 100 obj's doing that the<br/>same time, would it be a queue which could look different each time depending<br/>on timing of individual commands in that split second, or would it be "nicely"<br/>queued? :)"<br/><br/>Javelin says, "Well, the queued commands go onto the back of the queue. Since<br/>we're already on whatever part of the queue is running the object's commands,<br/>in general, they should be queued right after the ones we're running. MUSH<br/>isn't really multitasking, after all -- it's a serial system. However, there<br/>are a couple of oddities...<br/><br/>First, the "wait queue" (commands set with @wait &lt;seconds&gt;=&lt;command-list&gt;) is<br/>kept separate, and those commands are inserted onto the main queue when it's<br/>their time.<br/><br/>Second, stuff typed by players directly into the MUSH gets bumped to the front<br/>of the queue. That's why, for example, if your +who is coded using @dolist,<br/>you can get paged and have it interrupt in the middle."<br/><br/>The good reasons for that are: <br/><br/>1. it makes the MUSH feel more responsive to players, and <br/>2. It lets @halt have nice high precedence so you can stop a runaway object!)"<br/><br/>Javelin says, "But if everything is object code, then everything started by a<br/>single attribute on an object should run to the end without any other object<br/>getting in the way."<br/>Javelin says, "Anybody else?"<br/><br/>Vedui says, "The problem I run into is that I @sel to ensure a command is only<br/>run once. ie, check for a counter .. "@sel v(counter)=1,fail,&amp;counter me=1" ..<br/> .. and if ya spam it enuf, it'll still run the command multiple times, simply<br/>since it seems to run a second command before the first even has time to set<br/>the counter to 1."<br/><br/>Javelin says, "Yes, this can happen. This is when you want a -1 semaphore. :)"<br/><br/>Trispis says, "mutex"<br/><br/>Vedui says, "which would suggest the queue isn't orderly lined up ;)"<br/><br/>Trispis says, "Who's spamming this? Players?"<br/><br/>Vedui says, "Yep :)"<br/><br/>Javelin says, "No, the problem is that those commands are being run 'as if'<br/>from a player socket, because they're triggered by directly typed commands."<br/><br/>Vedui says, "ohh..."<br/><br/>Trispis nods. That's why you need the -1 semaphore (player actions get bumped<br/>to the front of the queue).<br/><br/>Javelin says, "So, second @sel gets queued up ahead of the counter<br/>incrementing."<br/><br/>Vedui says, "I thought the queue was arranged after the object, not that it<br/>was the triggering player who'd triggered it. Ick :) that'd do it yeah."<br/><br/>Javelin looks around for a stack of "Queue Guru" buttons for the participants.<br/>:)<br/><br/>Trispis grins at Jav, I'll leave an edited WHO (no sites) in the log. (:<br/>Sat Feb 14 23:29:58 1998<br/><br/>Vedui says, "Eh Jav, ya always want contributions to the God Manual.. how<br/>about putting in a section of how the queue works? ;)"<br/>Vedui says, "unless ya already did and I just aint read it recently enuf ;)"<br/><br/>Javelin says, "Good idea. You can write one now and send it to me. :)"<br/><br/>Vedui bleahs. Sure... as soon as I finish half of my other work ;)<br/><br/>Trispis says, "I'll have this log ready tomorrow... you can copy/paste the<br/>queue portion over to the manual. (:"<br/><br/>Vedui looks at his calendar, "is next year okay? ;)"<br/><br/>Javelin knows how you feel. :) "Well, I guess we'll finish here. Thanks for <br/>coming."<br/><br/>Vedui applauds<br/>Vedui *8)<br/><br/>Trispis applauds also and walks once again to the front of the room.<br/>Trispis shakes Javelin's hand (sorry for the powerplay) and says, "Class<br/>dismissed. Thanks for attending. The log will be available at<br/>ftp://mush101.pennmush.org/mush101/ClassLogs ... tomorrow afternoon."<br/><br/>Javelin takes Two-step.<br/>Javelin takes Race Condition.<br/>Javelin takes Semaphore Solution.<br/>Javelin takes Partial Fix.<br/><br/>Trispis stops logging.<br/>
    </div>
</div>
<script type="text/javascript">
    var selectText = function(element) {
        var doc = document;
        var text = doc.getElementById(element);

        if (doc.body.createTextRange) { // ms
            var range = doc.body.createTextRange();
            range.moveToElementText(text);
            range.select();
        } else if (window.getSelection) { // moz, opera, webkit
            var selection = window.getSelection();
            var range = doc.createRange();
            range.selectNodeContents(text);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    }

    $('a.select-all').click(function () {
        selectText('code');
    });
</script>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</body>

</html>
<script src="../Scripts/Google.js" type="text/javascript"></script>