@create Max's Table Code Parent
@link Max's Table Code Parent = #480
@parent Max's Table Code Parent=#527
@set Max's Table Code Parent=LINK_OK
@set Max's Table Code Parent=VISUAL
@set Max's Table Code Parent=SAFE
@set Max's Table Code Parent=MONITOR
&TABLEHELP Max's Table Code Parent=$tablehelp:[pemit(%#,[get_eval(me/help_places)])]
&PLACE2 Max's Table Code Parent=Table 2|3|2||I'm sorry, there's no room to add a place there.|I'm sorry, there's on place to move there.|You sit down at|sits down at|You stand and leave|stands and leaves|At your table
&PLACE1 Max's Table Code Parent=Table 1|2|2||I'm sorry, there's no room to add a place there.|I'm sorry, there's on place to move there.|You sit down at|sits down at|You stand and leave|stands and leaves|At your table
&PLACESMAX Max's Table Code Parent=2
&FUNC_WHICHPLACE Max's Table Code Parent=[switch(or(controls(%#,%0),match(rloc(%l,100),rloc(%0,100))),1,match(get(%0/PLACENUMS), *%1%b*, |),PERMISSION DENIED)]
&FUNC_PLACEINFO Max's Table Code Parent=[switch(or(controls(%#,%0),match(rloc(%l,100),rloc(%0,100))),1,extract(get(%0/PLACE%1),match(NAME MAXPLACES CURPLACES FIXED FULL EMPTY JOIN OJOIN DEPART ODEPART PREFIX,%2),1,|),PERMISSION DENIED)]
&FUNC_ATPLACE Max's Table Code Parent=[switch(or(controls(%#,%0),match(rloc(%l,100),rloc(%0,100))),1,extract(get(%0/PLACENUMS), %1, 1, |),PERMISSION DENIED)]
&HELP_PLACES_OPTIONS Max's Table Code Parent=%b%bUpdate <Place #>/<Option>=<Configuration Text>%r%r%b%bOption Description%t<Option>%tDefault Configuration Text%r%b%b------------------%t--------%t--------------------------%r%b%bPlace Name%t%tNAME%t%tTable x%r%b%bMaximum # of places%tMAXPLACES%tRandom%r%b%bCurrent # of places%tCURPLACES%tRandom (1 >= # >= MAXPLACES)%r%b%bFixed fail message%tFIXED%t%t<NULL>%r%b%bFull fail message%tFULL%t%tThat table has no more room.%r%b%bJoin message%t%tJOIN%t%tYou sit down at <place>.%r%b%bOjoin message%t%tOJOIN%t%tsits down at <place>.%r%b%bDepart message%tDEPART%t%tYou stand and leave <place>.%r%b%bOdepart message%tODEPART%t%tstands and leaves <place>.%r%b%bSay prefix%t%tPREFIX%t%tAt your table%r
&HELP_PLACES_CONFIG Max's Table Code Parent=%rPLACES configuration:%r%b%bConfigure <num> places%r%b%bUnconfigure places%r%r%b%bNotes: A null fixed message means vacancies can be moved freely to and from the place. % This does not make sense for things like couches and rugs. % Set it to something like "That makes no sense." if you are using such a place.%r%b%b(O)Join and (O)depart messages take like this: %%%%N. All Join and Depart messages are appended with the place name.%r%rOne important thing you must do is create an object to sit in the room set DARK and MONITOR.  Then you have to set an attribute on it with the following code:%r^* has left.:\[u(<room's dbref>/placescleanupcmd,<room's db>,\%#)]%rThis code enables the table code to remove people who leave the room or teleport out of the room.%r%rFunctions:%r%b%bWHICHPLACE(<loc num>,<dbnum>) gives the number of a place where <dbnum> is.%r%b%bATPLACE(<loc num>,<place num>) gives you a list of things at a place.%r%b%bPLACEINFO(<loc num>,<place num>,<option>) gives the value of <option> at place.%r%r
&HELP_PLACES Max's Table Code Parent=%rPlaces are virtual places to sit, stand or occupy. You remain in the same%rroom, but join a group of people within that room who may or may not be%rhaving a quiet conversation only with others placed with them.%r%r%b%bCommands:%r%b%b---------%r%b%b[ljust(Mv from <#> to <#>,28)]Moves a vacancy from one place to another.%r%b%b[ljust(Join <place name>,28)]Puts you at <place name>%r%b%b[ljust(Join at #<num>,28)]Puts you at place #<num>.%r%b%b[ljust(Join with <name>,28)]Puts you at the place with <name>.%r%b%b[ljust(Stand,28)]Removes you from your place.%r%b%b[ljust(Places,28)]Lists who's present at all places.%r%b%b[ljust(Place <num>,28)]Lists who's present at place <num>.%r%b%b[ljust(Plook,28)]Lists in column format everyone around the room.%r%b%b[ljust(tt <message>,28)](Tete a tete) Relays a message%r[space(30)]to all those at your place. This command takes%r[space(30)]the usual say/pose tokens, and TT |<message>%r[space(30)]will emit.%r%b%b[ljust(Update <#>/<Option>=<text>,28)]Type 'optionhelp'%r%rFor installation help, type 'confighelp'. This code is provided courtesy of Deirdre, Meg, and Osric of AmberMUSH.  It has been modified for use with B5 mush by Maximillian.  @mail him if you have questions or comments.
&ATPLACE Max's Table Code Parent=[extract(get(%0/PLACENUMS), %1, 1, |)]
&UPDATEINFO Max's Table Code Parent=[replace(get(%0/PLACE%1),match(NAME MAXPLACES CURPLACES FIXED FULL EMPTY JOIN OJOIN DEPART ODEPART PREFIX,%2),%3,|)]
&GETINFO Max's Table Code Parent=[extract(get(%0/PLACE%1),match(NAME MAXPLACES CURPLACES FIXED FULL EMPTY JOIN OJOIN DEPART ODEPART PREFIX,%2),1,|)]
&WHICHPLACE Max's Table Code Parent=[match(get(%0/PLACENUMS),*%1%b*,|)]
&DO_TT Max's Table Code Parent=$tt *: [setq(0,u(WHICHPLACE,%l,%#))][iter([switch(%q0,0,%#[setq(1,Please join a place first.)],[extract(get(%l/PLACENUMS),%q0,1,|)][setq(1,[u(GETINFO,%l,%q0,PREFIX)]\, [switch(%0,:*,%N [delete(%0,0,1)],\;*,%N[delete(%0,0,1)],"*,%N says "[delete(%0,0,1)]",|*,delete(%0,0,1),%N says "%0")])])],[pemit(##,%q1)])]
&NAME_3AUX_FN Max's Table Code Parent=%0[switch(mod(words(%0),4),0,%r[space(33)][ljust(mid(%1,0,14),15)],[ljust(mid(%1,0,14),15)])]
&NAME_3COL_FN Max's Table Code Parent=[fold(NAME_3AUX_FN,rest(%0),%r[space(33)][ljust(mid(first(%0),0,14),15)])]
&PLOOK_FOLD_FN Max's Table Code Parent=%0%r[setq(1,extract(get(%l/PLACENUMS),%1,1,|))]Place #[ljust(%1,5)] [rjust([sub(u(GETINFO,%l,%1,CURPLACES),words(%q1)] empty places,15)] [space(3)] [setq(2,sort(iter(%q1,name(##))))][ljust(mid(extract(%q2,1,1),0,14),14)] [ljust(mid(extract(%q2,2,1),0,14),14)] [ljust(mid(extract(%q2,3,1),0,14),14)][switch(gt(words(%q2),3),1,u(NAME_3COL_FN,extract(%q2,4,3999)))]
&DO_PLOOK Max's Table Code Parent=$plook: @pemit %#=[setq(0,edit(get(%l/PLACENUMS),|,))][fold(PLOOK_FOLD_FN,rest(lnum(add(get(%l/PLACESMAX),1))),-----)]%rNo place [space(3)] [setq(3,setdiff(setinter(lcon(%l),lwho()),r(0)))][rjust([words(r(3))] at no places,15)] [space(3)] [setq(4,sort(iter(r(3),name(##))))][ljust(mid(extract(r(4),1,1),0,14),14)] [ljust(mid(extract(r(4),2,1),0,14),14)] [ljust(mid(extract(r(4),3,1),0,14),14)][switch(gt(words(r(4)),3),1,u(NAME_3COL_FN,extract(r(4),4,3999)))]%r-----
&PLACE_LOOK Max's Table Code Parent=[setq(9,words(%0))][switch(%q9,0,,1,name(%0),2, [name(first(%0))] and [name(rest(%0))],[iter(extract(%0,1,sub(%q9,1)),{name(##),})] and [name(extract(%0,%q9,1))])]
&PLACES_FN Max's Table Code Parent=%r[setq(0,u(GETINFO,%l,%0,CURPLACES))][setq(1,extract(get(%l/PLACENUMS),%0,1,|))][capstr(u(GETINFO,%l,%0,NAME))] (#%0) has [setq(2,sub(%q0,words(%q1)))][switch(%q2,0,no empty places,1,1 empty place,%q2 empty places)].[switch(words(%q1),0,,1,%r%tPresent is: %b[name(first(%q1))].,%r%tPresent are: %b[u(PLACE_LOOK,%q1)].)]
&DO_PLACE Max's Table Code Parent=$place *: [pemit(%#,[switch(get(%l/PLACESMAX),,There are no special places here.,0,There are no special places here.,[switch(isnum(%0),0,%0 is not a number.  Please choose a number from 1 to [get(%l/PLACESMAX)].,map(PLACES_FN,edit(%0,#,)))])])]
&DO_PLACES Max's Table Code Parent=$places: [pemit(%#,[switch(get(%l/PLACESMAX),,There are no special places here.,0,There are no special places here.,map(PLACES_FN,rest(lnum(add(get(%l/PLACESMAX),1)))))])]
&DO_DEPART Max's Table Code Parent=$stand:[setq(1, U(WHICHPLACE, %l, %#))][setq(0,U(GETINFO,%l,%q1,NAME))][pemit(%#,[switch(0,%q1,You aren't placed anywhere.,[set(%l,PLACENUMS:[replace(get(%l/PLACENUMS), %q1, [remove(extract(get(%l/PLACENUMS), %q1, 1, |), %#)], |)])][U(GETINFO, %l, %q1, DEPART)] %q0[oemit(%#,%N [U(GETINFO, %l, %q1, ODEPART)] %q0.)])])]
&PLACEFUNCTION Max's Table Code Parent=[pemit(%1,[switch(0,[lte(%2, get(%0/PLACESMAX))],Invalid Place Number '%2'.,[setq(1, extract(get(%0/PLACENUMS),%2,1,|))][gt(u(GETINFO,%0,%2,CURPLACES),words(%q1))],There aren't any free spaces there.,[setq(0,u(getinfo,%0,%2,NAME))][U(GETINFO, %l, %2, JOIN)] %q0[oemit(%1,[name(%1)] [U(GETINFO,%l,%2,OJOIN)] %q0.)][set(%0,PLACENUMS:[replace(get(%0/PLACENUMS),%2,%q1%1%b,|)])])])]
&DO_JOIN Max's Table Code Parent=$join *: @switch/first [not(u(WHICHPLACE,%l,%#))] [lcstr(%0)]=0 *, [pemit(%#,Don't you think you should 'stand' first?)],1 at #*, [u(PLACEFUNCTION,%l,%#,[delete(rest(%0),0,1)])],1 at *,[pemit(%#,That's not a table number.%rThe correct format is join at #<table number>)],1 #*, [u(PLACEFUNCTION,%l,%#,[delete(%0,0,1)])],1 with *,[setq(1,[pmatch([first(rest(%0))])])])][setq(0,u(WHICHPLACE,%l,%q1))][pemit(%#,[switch(%q0,0,There isn't anyone named '[capstr(rest(%0))]' at a special place.,You go over to join [name(%q1)].)])][u([switch(%q0,0,-,PLACEFUNCTION)],%l,%#,%q0)], [u(PLACEFUNCTION,%l,%#,[match(iter(rest(lnum(add(get(%l/PLACESMAX),1))),[u(GETINFO,%l,##,NAME)]|),*%0*,|)])]
&PLACESCLEANUPCMD Max's Table Code Parent=[setq(0,u(WHICHPLACE,%0,%1))][switch([or([lte(%q0,0)],[gt(%q0,[get(%0/PLACESMAX)])])],1,,[set(%0,PLACENUMS:[replace(get(%0/PLACENUMS),%q0,[remove(extract(get(%0/PLACENUMS),%q0,1,|),%1)],|)])])]
&PLACESCLEANUP2 Max's Table Code Parent=^* has disconnected.:[u(#966/placescleanupcmd,#966,[pmatch(*%0)])]
&PLACESCLEANUP1 Max's Table Code Parent=^* has left.:[u(#966/placescleanupcmd,#966,[pmatch(*%0)])]
&DO_MOVE Max's Table Code Parent=$mv from * to *: @switch/first 0=and(gt(%0,0),lte(%0,get(%l/PLACESMAX))), {@pemit %#='%0' is not a valid place number.},and(gt(%1,0),lte(%1,get(%l/PLACESMAX))), {@pemit %#='%1' is not a vaild place number.},not(words(u(GETINFO,%l,%0,FIXED))), {@pemit %#=u(GETINFO,%l,%0,FIXED)},not(words(u(GETINFO,%l,%1,FIXED))), {@pemit %#=u(GETINFO,%l,%1,FIXED)},sub(u(GETINFO,%l,%0,CURPLACES),words(extract(get(%l/PLACENUMS),%0,1,|))), {@pemit %#=u(GETINFO,%l,%0,EMPTY)},neq(u(GETINFO,%l,%1,CURPLACES),u(GETINFO,%l,%1,MAXPLACES)), {@pemit %#=u(GETINFO,%l,%1,FULL)}, {@unlock %l/PLACE%0; @unlock %l/PLACE%1; &PLACE%0 %l=u(UPDATEINFO,%l,%0,CURPLACES,sub(u(GETINFO,%l,%0,CURPLACES),1)); &PLACE%1 %l=u(UPDATEINFO,%l,%1,CURPLACES,add(u(GETINFO,%l,%1,CURPLACES),1)); @pemit %#=You move a place from [u(GETINFO,%l,%0,NAME)] to [u(GETINFO,%l,%1,NAME)].}
&DO_UPDATE Max's Table Code Parent=$update */*=*: @switch/first [controls(%#,%l)]:[and(isnum(%0),lte(%0,get(%l/PLACESMAX)))]:[member(NAME MAXPLACES CURPLACES FIXED FULL EMPTY JOIN OJOIN DEPART ODEPART PREFIX,ucstr(%1))]=0:*:*, {@pemit %#=Permission denied.},*:0:*, {@pemit %#=I'm sorry, but '%0' isn't a valid place number.},*:*:0, {@pemit %#=I'm sorry, but '%1' isn't a valid configuration option.}, {@unlock %l/PLACE%0; &PLACE%0 %l=u(UPDATEINFO,%l,%0,%1,%2); @pemit %#=The %1 for [u(GETINFO,%l,%0,NAME)] is now set to:%r[space(5)][u(GETINFO,%l,%0,%1)]}
&SETUP_FN Max's Table Code Parent=Table %0|%1|[add(rand(%1),1)]||I'm sorry, there's no room to add a place there.|I'm sorry, there's no places to move from there.|You sit down at|sits down at|You stand and leave|stands and leaves|At your table
&DO_CONFIGURE Max's Table Code Parent=$configure * places: @switch/first [controls(%#,%l)]:[isnum(%0)]:%0=0:*:*, {@pemit %#=You do not control [name(%l)].},*:0:*, {@pemit %#=The number of places needs to be a number!},*:*:0, {@dolist rest(lnum(add(get(%l/PLACESMAX),1)))={@unlock %l/PLACE##; &PLACE## %l}; @unlock %l/PLACESCLEANUP1; @unlock %l/PLACESCLEANUP2; @unlock %l/PLACESMAX; &PLACESCLEANUP1 %l; &PLACESCLEANUP2 %l; &PLACESMAX %l; @set %l=!MONITOR; @pemit %#=Places removed from [name(%l)].}, {&PLACESMAX %l=%0; @dolist rest(lnum(add(%0,1)))={@unlock %l/PLACE##; &PLACE## %l=u(SETUP_FN,##,add(rand(9),1))}; @unlock %l/PLACESCLEANUP1; @unlock %l/PLACESCLEANUP2; @unlock %l/PLACESMAX; @set %l=MONITOR; &PLACESCLEANUP2 %l=^* has disconnected.:\[u(%l/PLACESCLEANUPCMD,%l,\[pmatch(*%0)])]; &PLACESCLEANUPCMD here=v(PLACESCLEANUPCMD);&PLACENUMS %l=[repeat(|,%0)];@pemit %#=Configuration for %0 places complete.}
&EVAL_OBJECT Max's Table Code Parent=#931
&OPTIONHELP Max's Table Code Parent=$optionhelp:[pemit(%#,[get_eval(me/help_places_options)])]
&CONFIGHELP Max's Table Code Parent=$confighelp:[pemit(%#,[get_eval(me/help_places_config)])]
&DESC1 Max's Table Code Parent=bob
